<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTS Love Yourself Tracker</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Love Yourself pastel theme */
    body {
      background: linear-gradient(135deg, #fbe8ff 0%, #f6f1ff 30%, #fff8f6 100%);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #2b2140;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 28px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.72));
      border: 1px solid rgba(43,33,64,0.06);
      box-shadow: 0 8px 30px rgba(99,79,160,0.08);
      border-radius: 14px;
    }
    .accent {
      background: linear-gradient(90deg, #ffd6f6 0%, #f5e1ff 100%);
      color: #3b2242;
    }
    .soft {
      color: rgba(43,33,64,0.7);
    }
    .btn {
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:active { transform: translateY(1px); }
    .icon { width: 20px; height: 20px; vertical-align: middle; }
    .title-gradient {
      background: linear-gradient(90deg,#ffb3e6,#e8d6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    a { text-decoration: none; }
  </style>
</head>
<body>

  <div id="root" class="max-w-4xl mx-auto"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;

  /* ---------- Helper SVG components (single definitions) ---------- */
  function IconCalendarSmall(props) {
    return (
      <svg className="icon" viewBox="0 0 24 24" fill="none" {...props}>
        <path d="M7 10h5" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
        <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" strokeWidth="1.6" fill="none"/>
        <path d="M16 3v4M8 3v4" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );
  }

  function IconMusicSmall() {
    return (
      <svg className="icon" viewBox="0 0 24 24" fill="none">
        <path d="M9 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
        <path d="M9 9V3l10 3v6" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );
  }

  function IconStarSmall() {
    return (
      <svg className="icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 2.9l2.4 4.8 5.3.8-3.8 3.7.9 5.2L12 16.9 6.2 17.4l.9-5.2L3.3 8.5l5.3-.8L12 2.9z" stroke="currentColor" strokeWidth="1.1" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
      </svg>
    );
  }

  /* ---------- Utility: calendar .ics generator ---------- */
  function downloadIcs(eventTitle, dateStr, description = "") {
    // Accepts YYYY-MM-DD or YYYYMMDD
    const dt = dateStr.replaceAll("-", "");
    const icsLines = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "BEGIN:VEVENT",
      "CLASS:PUBLIC",
      `SUMMARY:${eventTitle}`,
      `DESCRIPTION:${description}`,
      `DTSTART;VALUE=DATE:${dt}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ];
    const ics = icsLines.join("\n");
    const blob = new Blob([ics], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${eventTitle}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /* ---------- MAIN APP ---------- */
  function App() {
    const [spotifyToken, setSpotifyToken] = useState(null);
    const [groupReleases, setGroupReleases] = useState([]);
    const [soloReleases, setSoloReleases] = useState([]);
    const [birthdaysToday, setBirthdaysToday] = useState([]);
    const [loading, setLoading] = useState(true);

    // ====== CONFIG - replace CLIENT_ID below with your Spotify Client ID ======
    const CLIENT_ID = "YOUR_SPOTIFY_CLIENT_ID"; // <-- replace this with your client ID
    const REDIRECT_URI = "https://mahimadas27.github.io/Music/"; // must match Spotify app redirect URL
    const SCOPE = "user-read-email";

    // BTS members (birthdays MM-DD)
    const BTS_MEMBERS = [
      { name: "RM", birthday: "09-12" },
      { name: "Jin", birthday: "12-04" },
      { name: "SUGA", birthday: "03-09" },
      { name: "j-hope", birthday: "02-18" },
      { name: "Jimin", birthday: "10-13" },
      { name: "V", birthday: "12-30" },
      { name: "Jungkook", birthday: "09-01" }
    ];

    // Build Spotify auth URL (implicit grant)
    function buildSpotifyAuthUrl() {
      return `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
             `&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
             `&scope=${encodeURIComponent(SCOPE)}`;
    }

    // Parse token from URL hash
    useEffect(() => {
      setLoading(true);
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token = params.get("access_token");
      if (token) {
        setSpotifyToken(token);
        // clean URL (remove fragment)
        history.replaceState(null, "", window.location.pathname);
      }
      // compute birthdays for today
      const today = new Date();
      const mmdd = String(today.getMonth()+1).padStart(2,"0") + "-" + String(today.getDate()).padStart(2,"0");
      const todays = BTS_MEMBERS.filter(m => m.birthday === mmdd);
      setBirthdaysToday(todays);

      // small delay for initial loading UI
      setTimeout(() => setLoading(false), 600);
    }, []);

    // Helper: fetch artist releases by artist name
    async function fetchArtistReleasesByName(name, token) {
      try {
        const q = encodeURIComponent(name);
        const searchRes = await fetch(`https://api.spotify.com/v1/search?q=${q}&type=artist&limit=1`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const searchJson = await searchRes.json();
        const artist = searchJson.artists?.items?.[0];
        if (!artist) return [];
        const artistId = artist.id;
        const albumsRes = await fetch(`https://api.spotify.com/v1/artists/${artistId}/albums?include_groups=album,single&limit=50&market=KR`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const albumsJson = await albumsRes.json();
        const items = albumsJson.items || [];
        const mapped = items.map(it => ({
          title: it.name,
          date: it.release_date,
          type: it.album_type,
          artistName: name
        }));
        // dedupe by title (case-insensitive)
        const seen = new Set();
        return mapped.filter(m => {
          const t = m.title.toLowerCase();
          if (seen.has(t)) return false;
          seen.add(t);
          return true;
        });
      } catch (e) {
        console.warn("Spotify fetch error for", name, e);
        return [];
      }
    }

    // load Spotify data after login
    useEffect(() => {
      async function loadSpotifyData() {
        if (!spotifyToken) return;
        setLoading(true);
        // group releases
        const group = await fetchArtistReleasesByName("BTS", spotifyToken);
        setGroupReleases(group.slice(0, 12));
        // solo releases for members
        const memberNames = ["RM","Jin","SUGA","j-hope","Jimin","V","Jungkook"];
        const allSolo = [];
        for (const m of memberNames) {
          const solo = await fetchArtistReleasesByName(m, spotifyToken);
          solo.forEach(s => s.artistName = m);
          allSolo.push(...solo.slice(0, 8));
        }
        setSoloReleases(allSolo.slice(0, 18));
        setLoading(false);
      }
      loadSpotifyData();
    }, [spotifyToken]);

    // Debut anniversary: BTS debut 2013-06-13
    const debutAnniv = { title: "BTS Debut Anniversary", date: `${new Date().getFullYear()}-06-13`, desc: "Debut of BTS — 13 June 2013" };

    return (
      <div className="space-y-6">
        <header className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold title-gradient">BTS — Love Yourself Tracker</h1>
            <p className="soft mt-1">Group & solo releases • Birthdays • Debut anniversary</p>
          </div>
          <div className="text-right">
            <div className="inline-flex items-center gap-2">
              <div className="px-3 py-2 rounded-md accent card text-sm">ARMY</div>
            </div>
          </div>
        </header>

        <main className="grid md:grid-cols-2 gap-6">
          {/* Left column: Group Releases */}
          <section className="card p-5">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 flex items-center justify-center rounded-full" style={{background:"#fff0f5"}}>
                  <svg className="icon" viewBox="0 0 24 24" fill="none" style={{width:18,height:18}}>
                    <path d="M9 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="#5b3b6f" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M9 9V3l10 3v6" stroke="#5b3b6f" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
                <h2 className="text-lg font-semibold">Group Releases</h2>
              </div>
              {spotifyToken ? <span className="text-sm soft">Spotify connected</span> : null}
            </div>

            {/* connect button if not connected */}
            {!spotifyToken && (
              <div className="mb-4">
                <button
                  className="btn px-4 py-2 rounded-md accent"
                  onClick={() => { window.location.href = buildSpotifyAuthUrl(); }}
                >
                  Login with Spotify
                </button>
              </div>
            )}

            {loading && <p className="soft">Loading releases…</p>}
            {!loading && groupReleases.length === 0 && <p className="soft">No recent group releases found.</p>}
            <div className="space-y-3">
              {groupReleases.map((r, i) => (
                <div key={i} className="flex items-center justify-between p-3 rounded-md" style={{background:"#fff8ff"}}>
                  <div>
                    <div className="font-semibold">{r.title}</div>
                    <div className="text-sm soft">{r.date} • BTS</div>
                  </div>
                  <div className="flex gap-2 items-center">
                    <button className="btn px-3 py-2 rounded-md" onClick={() => downloadIcs(`${r.title} — BTS`, r.date, `BTS release: ${r.title}`)}>
                      <IconCalendarSmall />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Right column: Solos + birthdays */}
          <section className="space-y-4">
            <div className="card p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <IconMusicSmall />
                  <h3 className="text-lg font-semibold">Solo Releases</h3>
                </div>
              </div>

              {loading && <p className="soft">Loading solos…</p>}
              {!loading && soloReleases.length === 0 && <p className="soft">No solo releases found.</p>}
              <div className="space-y-2">
                {soloReleases.map((s, i) => (
                  <div key={i} className="flex items-center justify-between p-3 rounded-md" style={{background:"#fff8ff"}}>
                    <div>
                      <div className="font-medium">{s.title}</div>
                      <div className="text-sm soft">{s.artistName} • {s.date}</div>
                    </div>
                    <div className="flex gap-2">
                      <button className="btn px-3 py-2 rounded-md" onClick={() => downloadIcs(`${s.title} — ${s.artistName}`, s.date, `Solo release: ${s.title} by ${s.artistName}`)}>
                        <IconCalendarSmall />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="card p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <IconStarSmall />
                  <h3 className="text-lg font-semibold">Today: Member Birthdays</h3>
                </div>
              </div>

              {birthdaysToday.length === 0 && (
                <div className="soft mb-2">No BTS member birthdays today.</div>
              )}
              {birthdaysToday.map((b,i) => (
                <div key={i} className="flex items-center justify-between p-3 rounded-md" style={{background:"#fff8ff"}}>
                  <div>
                    <div className="font-medium">{b.name}</div>
                    <div className="text-sm soft">BTS • {b.birthday}</div>
                  </div>
                  <div>
                    <button className="btn px-3 py-2 rounded-md" onClick={() => {
                      const year = new Date().getFullYear();
                      downloadIcs(`${b.name} Birthday`, `${year}-${b.birthday}`, `${b.name} (BTS) birthday`);
                    }}>
                      <IconCalendarSmall />
                    </button>
                  </div>
                </div>
              ))}

              <hr className="my-3" />
              <div className="flex items-center justify-between">
                <div>
                  <div className="font-semibold">Debut Anniversary</div>
                  <div className="text-sm soft">June 13 — 2013</div>
                </div>
                <div>
                  <button className="btn px-3 py-2 rounded-md accent" onClick={() => downloadIcs(debutAnniv.title, debutAnniv.date, debutAnniv.desc)}>
                    <IconCalendarSmall />
                    <span className="ml-2 soft">Add</span>
                  </button>
                </div>
              </div>

            </div>
          </section>
        </main>

        <footer className="text-sm soft mt-6">
          <div className="flex items-center justify-between">
            <div>Made for ARMY • Love Yourself theme</div>
            <div>Tip: Replace <code>YOUR_SPOTIFY_CLIENT_ID</code> in code and add <code>{REDIRECT_URI || 'https://mahimadas27.github.io/Music/'}</code> as a redirect URI in your Spotify app settings.</div>
          </div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
